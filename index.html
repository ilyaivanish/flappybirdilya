<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Flappy Bird</title>
    <script src="//cdn.jsdelivr.net/npm/phaser@3.18.0/dist/phaser.js"></script>
    <style type="text/css">
        body {
            margin: 0;
        }
        canvas {
            display: block;
            margin: 0 auto;
        }
    </style>
</head>
<body>

    <script type="text/javascript">

        var config = {
            type: Phaser.AUTO,
            width: 288,
            height: 512,
            physics: {
                default: 'arcade',
                arcade: {
                    gravity: {
                        y: 300
                    },
                    debug: false
                }
            },
            scene: {
                preload: preload,
                create: create,
                update: update
            }
        };

        let game = new Phaser.Game(config);

        function pauseGame(scene) {
            scene.physics.pause();
        }


        function preload() {
            // Backgrounds and ground
            this.load.image('background', 'assets/background-day.png')
            this.load.spritesheet('ground', 'assets/ground-sprite.png', {
                frameWidth: 336,
                frameHeight: 112
            })

            // Pipes
            this.load.image('pipeTop', 'assets/pipe-green-top.png')
            this.load.image('pipeBottom', 'assets/pipe-green-bottom.png')
            this.load.image('line', 'assets/pipe-line.png')

            // Bird
            this.load.spritesheet('bird', 'assets/bird-red-sprite.png', {
                frameWidth: 34,
                frameHeight: 24
            })

            // Start game
            this.load.image('start', 'assets/message-initial.png')

            // End game
            this.load.image('gameOver', 'assets/gameover.png')
            this.load.image('restart', 'assets/restart-button.png')

            pauseGame(this);
        }

        function create() {
            // Добавление фона
            // Create the background
            this.add.image(0, 0, 'background').setOrigin(0, 0);

            // Create the ground
            ground = this.physics.add.sprite(168, 500, 'ground');
            ground.setCollideWorldBounds(false);
            ground.body.immovable = true;
            ground.body.allowGravity = false;

            this.anims.create({
                key: 'moving-ground',
                frames: this.anims.generateFrameNumbers('ground', {
                    start: 0,
                    end: 2
                }),
                frameRate: 15,
                repeat: -1
            })

            ground.anims.play('moving-ground', true)

            // птичка
            bird = this.physics.add.sprite(100, 250, 'bird').setScale(2);
            bird.setCollideWorldBounds(true);
            bird.body.gravity.y = 900;

            // Add bird animations
            this.anims.create({
                key: 'fly',
                frames: this.anims.generateFrameNumbers('bird', { 
                    start: 0, 
                    end: 2 
                }),
                frameRate: 10,
                repeat: -1
            });

            // анимация полета
            bird.anims.play('fly', true);

            // полет вверх после нажатия на пробел
            this.input.keyboard.on('keydown_SPACE', () => {
                bird.setVelocityY(-400);
            });

            // Pipes
            pipes = this.physics.add.group();

            function createPipe() {
                // Calculate the position of the gap between the pipes
                const GAP_HEIGHT = 200;
                const GAP_Y = Phaser.Math.Between(GAP_HEIGHT, game.config.height - GAP_HEIGHT);

                // Create the top pipe
                const topPipe = pipes.create(game.config.width + 100, GAP_Y - GAP_HEIGHT / 2, 'pipeTop');
                topPipe.setOrigin(1, 1,5);
                topPipe.body.setAllowGravity(false);
                topPipe.body.setVelocityX(-200);

                // Create the bottom pipe
                const bottomPipe = pipes.create(game.config.width + 100, GAP_Y + GAP_HEIGHT / 2, 'pipeBottom');
                bottomPipe.setOrigin(1, 0,5);
                bottomPipe.body.setAllowGravity(false);
                bottomPipe.body.setVelocityX(-200);

                // линия для пересечения и подсчета очков
                const line = this.physics.add.sprite(game.config.width + 100, GAP_Y, 'line');
                line.setOrigin(0.5, 0.5);
                line.body.setAllowGravity(false);
                line.body.setVelocityX(-200);
                line.body.setSize(2, GAP_HEIGHT, true);
                
            }

  
            // Add start button
            const messageInitial = this.add.image(144, 190, 'start');
            messageInitial.setInteractive();
            messageInitial.on('pointerdown', () => {
                messageInitial.visible = false;
                this.physics.resume();
                this.time.addEvent({
                    delay: 2000,
                    callback: createPipe,
                    callbackScope: this,
                    loop: true
                });
            });

            // создаем иконку конец игры
            this.gameOver = this.add.image(144, 256, 'gameOver');
            this.gameOver.setVisible(false);

            // создаем рестарт кнопку
            this.restartButton = this.add.image(144, 300, 'restart').setInteractive();
            this.restartButton.setVisible(false);

            // счет
            this.scoreText = this.add.text(16, 16, 'Score: 0', { fontSize: '32px', fill: '#000' });
            
            function handlePassingPipe(bird, pipe) {
                if (bird.x > pipe.x && !pipe.data.values.scored) {
                    pipe.data.values.scored = true;
                    this.score++;
                    this.scoreText.setText(`Score: ${this.score}`);
                }
            }

            this.physics.add.overlap(bird, pipes, null, handlePassingPipe, this);
        }

        function update() {

            // функция которая вызывается после столкновения
            function handleCollide() {
                // End the game and pause the physics engine
                pauseGame(this)

                // показываем гейм овер
                this.gameOver.setVisible(true);

                // Показываем кнопку перезапуска
                this.restartButton.setVisible(true);
                this.restartButton.on('pointerdown', function() {
                    // Перезапускаем игру
                    this.scene.restart();
                }, this);
            }

            this.physics.world.collide(bird, pipes, handleCollide, null, this);

            this.physics.world.collide(bird, ground, handleCollide, null, this);

            function handlePassingPipe(bird, pipe) {
                this.gameOver.setVisible(true);
            }


        }
    </script>
</body>
</html>
